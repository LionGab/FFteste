{
  "name": "üí¨ Academia Full Force - Resposta Autom√°tica WAHA",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "academia-whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-waha",
      "name": "üì± WAHA Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parser otimizado para WAHA API\nconst payload = $input.first().json;\n\n// Estrutura t√≠pica WAHA\nconst event = payload.event || 'message';\nconst sessionId = payload.session || 'default';\nconst messageData = payload.payload || payload;\n\n// Extrair dados da mensagem\nconst chatId = messageData.from || messageData.chatId;\nconst messageBody = messageData.body || messageData.text || '';\nconst messageText = messageBody.toLowerCase().trim();\nconst contactName = messageData.notifyName || messageData.pushName || 'Cliente';\nconst contactPhone = chatId.replace('@c.us', '').replace('+55', '');\n\n// Verificar se √© mensagem v√°lida\nif (!chatId || !messageText || messageData.fromMe) {\n  return { json: { skip: true, reason: 'Mensagem inv√°lida ou pr√≥pria' } };\n}\n\n// DETECTOR DE INTERESSE (palavras-chave de convers√£o)\nconst interesseKeywords = {\n  alta_intencao: ['sim', 'quero', 'aceito', 'top', 'vamos', 'quando', 'hoje', 'agora', 'agendar', 'marcar'],\n  duvidas: ['quanto', 'valor', 'pre√ßo', 'preco', 'custa', 'plano', 'horario', 'hor√°rio', 'funciona'],\n  objecoes: ['caro', 'n√£o', 'nao', 'depois', 'mais tarde', 'pensando', 'talvez'],\n  urgente: ['emergencia', 'urgente', 'preciso', 'ajuda']\n};\n\n// Classificar inten√ß√£o\nlet intencao = 'neutro';\nlet prioridade = 'baixa';\n\nfor (const [tipo, palavras] of Object.entries(interesseKeywords)) {\n  if (palavras.some(palavra => messageText.includes(palavra))) {\n    intencao = tipo;\n    prioridade = tipo === 'alta_intencao' ? 'critica' : \n                 tipo === 'duvidas' ? 'alta' : \n                 tipo === 'urgente' ? 'critica' : 'media';\n    break;\n  }\n}\n\n// Detectar hora do dia para personaliza√ß√£o\nconst agora = new Date();\nconst hora = agora.getHours();\nconst cumprimento = hora < 12 ? 'Bom dia' : hora < 18 ? 'Boa tarde' : 'Boa noite';\n\nreturn {\n  json: {\n    chatId,\n    contactName,\n    contactPhone,\n    messageText,\n    messageOriginal: messageBody,\n    intencao,\n    prioridade,\n    cumprimento,\n    timestamp: agora.toISOString(),\n    sessionId\n  }\n};"
      },
      "id": "parse-waha",
      "name": "üîç Parse WAHA Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "skip-check",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-valid",
      "name": "‚úÖ Filtro Mensagens",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": "1YviQakfTbBNZWkFOLqxIi5EORfOPmKTJz_qr-inIvo8",
        "sheetName": "Conversas",
        "range": "A:H",
        "keyRowIndex": 2,
        "options": {
          "headerRow": 1
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Telefone": "={{ $json.contactPhone }}",
            "Nome": "={{ $json.contactName }}",
            "Mensagem": "={{ $json.messageOriginal }}",
            "Intencao": "={{ $json.intencao }}",
            "Prioridade": "={{ $json.prioridade }}",
            "Data_Hora": "={{ $now.format('DD/MM/YYYY HH:mm') }}",
            "Status": "Recebida",
            "Observacoes": "Auto processada"
          }
        }
      },
      "id": "save-conversation",
      "name": "üíæ Salvar Conversa",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [900, 200]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.prioridade }}",
        "rules": {
          "rules": [
            {
              "operation": "equal",
              "value2": "critica"
            },
            {
              "operation": "equal",
              "value2": "alta"
            },
            {
              "operation": "equal",
              "value2": "media"
            }
          ]
        }
      },
      "id": "route-priority",
      "name": "üéØ Router Prioridade",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "// RESPOSTA CR√çTICA - ALTA CONVERS√ÉO\nconst dados = $json;\n\nconst respostasCriticas = {\n  'sim': `üî• *PERFEITO ${dados.contactName}!*\\n\\n‚úÖ Sua vaga est√° GARANTIDA!\\n\\nüìç *Academia Full Force*\\nRua das Academias, 123\\n\\n‚è∞ *Hor√°rios:*\\n‚Ä¢ Segunda a Sexta: 6h √†s 22h\\n‚Ä¢ S√°bado: 8h √†s 18h\\n\\nüéÅ *B√îNUS ESPECIAL:*\\n‚Ä¢ Avalia√ß√£o f√≠sica GR√ÅTIS\\n‚Ä¢ 1¬™ semana de Personal inclusa\\n\\nüìû *Confirme agora:* (11) 99999-9999\\n\\nüí™ Nos vemos hoje mesmo!`,\n  \n  'quero': `üöÄ *EXCELENTE ${dados.contactName}!*\\n\\nüéØ Voc√™ tomou a MELHOR decis√£o!\\n\\nüí∞ *Oferta confirmada:*\\n‚Ä¢ R$ 49,90 primeiro m√™s\\n‚Ä¢ Sem taxa de matr√≠cula\\n‚Ä¢ Cancele quando quiser\\n\\nüì± *PR√ìXIMO PASSO:*\\nVenha hoje mesmo com:\\n‚Ä¢ RG e CPF\\n‚Ä¢ Atestado m√©dico (se tiver)\\n\\nüî• *Vamos come√ßar SUA transforma√ß√£o!*\\n\\nüìû D√∫vidas: (11) 99999-9999`,\n  \n  'aceito': `üéâ *FANT√ÅSTICO ${dados.contactName}!*\\n\\n‚ú® Bem-vindo √† fam√≠lia Full Force!\\n\\nüéÅ *Seus benef√≠cios:*\\n‚Ä¢ Acesso total aos equipamentos\\n‚Ä¢ Aulas coletivas inclusas\\n‚Ä¢ App de treinos personalizado\\n‚Ä¢ Suporte nutricional\\n\\nüìç *Nos encontre:*\\nRua das Academias, 123\\nS√£o Paulo - SP\\n\\n‚ö° *Venha hoje e ganhe kit welcome!*\\n\\nüìû WhatsApp: (11) 99999-9999`,\n  \n  'default': `üî• *${dados.cumprimento} ${dados.contactName}!*\\n\\nüí™ Vi que voc√™ tem INTERESSE REAL!\\n\\nüéØ *OFERTA ESPECIAL HOJE:*\\nüí∞ Primeira mensalidade R$ 49,90\\nüéÅ Avalia√ß√£o f√≠sica GRATUITA\\n‚è∞ V√°lido s√≥ at√© 23:59h\\n\\n‚úÖ *BENEF√çCIOS INCLUSOS:*\\n‚Ä¢ Muscula√ß√£o completa\\n‚Ä¢ Cardio de √∫ltima gera√ß√£o\\n‚Ä¢ Aulas coletivas\\n‚Ä¢ App personalizado\\n\\nüìû *Responda SIM e garante j√°!*\\n\\nüèÉ‚Äç‚ôÇÔ∏è Vagas limitadas!`\n};\n\n// Escolher resposta baseada na mensagem\nlet resposta = respostasCriticas.default;\nfor (const [key, value] of Object.entries(respostasCriticas)) {\n  if (key !== 'default' && dados.messageText.includes(key)) {\n    resposta = value;\n    break;\n  }\n}\n\nreturn {\n  json: {\n    chatId: dados.chatId,\n    resposta: resposta,\n    prioridade: 'critica',\n    followUpDelay: '2 hours' // Follow-up em 2 horas se n√£o responder\n  }\n};"
      },
      "id": "response-critical",
      "name": "üö® RESPOSTA CR√çTICA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 180]
    },
    {
      "parameters": {
        "jsCode": "// RESPOSTA ALTA PRIORIDADE - INFORMA√á√ïES\nconst dados = $json;\n\nconst respostasAltas = {\n  'quanto': `üí∞ *VALORES ESPECIAIS ${dados.contactName}:*\\n\\nüî• *PROMO√á√ÉO REL√ÇMPAGO:*\\n‚Ä¢ 1¬∫ m√™s: R$ 49,90\\n‚Ä¢ Demais: R$ 89,90\\n‚Ä¢ SEM taxa de matr√≠cula\\n\\nüéÅ *INCLUSO GR√ÅTIS:*\\n‚Ä¢ Avalia√ß√£o f√≠sica completa\\n‚Ä¢ Plano de treino personalizado\\n‚Ä¢ Acesso ao app Full Force\\n‚Ä¢ Todas as aulas coletivas\\n\\n‚è∞ *Oferta v√°lida AT√â HOJE!*\\n\\nüìû *Interessado? Responda SIM!*`,\n  \n  'horario': `‚è∞ *HOR√ÅRIOS ${dados.contactName}:*\\n\\nüóìÔ∏è *FUNCIONAMENTO:*\\n‚Ä¢ Segunda a Sexta: 6h √†s 22h\\n‚Ä¢ S√°bado: 8h √†s 18h\\n‚Ä¢ Domingo: 8h √†s 14h\\n\\nüèãÔ∏è *HOR√ÅRIOS DE PICO:*\\n‚Ä¢ Manh√£: 7h √†s 9h\\n‚Ä¢ Tarde: 17h √†s 20h\\n\\n‚ú® *DICA VIP:* 14h √†s 17h academia mais vazia = atendimento VIP!\\n\\nüí™ *Que tal conhecer hoje?*\\n\\nüìû *Responda SIM para agendar!*`,\n  \n  'plano': `üìã *PLANOS ${dados.contactName}:*\\n\\nü•â *B√ÅSICO* - R$ 89,90\\n‚Ä¢ Muscula√ß√£o + Cardio\\n‚Ä¢ Vesti√°rios\\n\\nü•à *COMPLETO* - R$ 129,90\\n‚Ä¢ Tudo do B√°sico +\\n‚Ä¢ Aulas coletivas\\n‚Ä¢ Zona funcional\\n\\nü•á *PREMIUM* - R$ 179,90\\n‚Ä¢ Tudo dos anteriores +\\n‚Ä¢ 2 Personal Trainers/m√™s\\n‚Ä¢ Avalia√ß√£o trimestral\\n\\nüî• *HOJE: 1¬∫ m√™s R$ 49,90 em qualquer plano!*\\n\\nüìû *Qual te interessa mais?*`,\n  \n  'default': `${dados.cumprimento} *${dados.contactName}!*\\n\\nüí™ Vejo que voc√™ quer saber mais sobre a Full Force!\\n\\nüéØ *BENEF√çCIOS √öNICOS:*\\n‚Ä¢ Equipamentos importados Technogym\\n‚Ä¢ Personal trainers certificados\\n‚Ä¢ Aulas com instrutores especializados\\n‚Ä¢ App com treinos personalizados\\n\\nüî• *OFERTA ESPECIAL:*\\nPrimeiro m√™s por apenas R$ 49,90\\n\\nüì± *Que informa√ß√£o espec√≠fica voc√™ quer?*\\n‚Ä¢ Valores\\n‚Ä¢ Hor√°rios\\n‚Ä¢ Modalidades\\n‚Ä¢ Localiza√ß√£o\\n\\nüìû *Estou aqui para ajudar!*`\n};\n\n// Escolher resposta baseada na mensagem\nlet resposta = respostasAltas.default;\nfor (const [key, value] of Object.entries(respostasAltas)) {\n  if (key !== 'default' && dados.messageText.includes(key)) {\n    resposta = value;\n    break;\n  }\n}\n\nreturn {\n  json: {\n    chatId: dados.chatId,\n    resposta: resposta,\n    prioridade: 'alta',\n    followUpDelay: '6 hours'\n  }\n};"
      },
      "id": "response-high",
      "name": "‚ö° RESPOSTA ALTA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 280]
    },
    {
      "parameters": {
        "jsCode": "// RESPOSTA PADR√ÉO - ENGAJAMENTO\nconst dados = $json;\n\nconst respostaPadrao = `${dados.cumprimento} *${dados.contactName}!*\\n\\nüí™ Obrigado pelo contato com a *Academia Full Force*!\\n\\nüî• *SOMOS ESPECIALISTAS EM:*\\n‚Ä¢ Emagrecimento definitivo\\n‚Ä¢ Ganho de massa muscular\\n‚Ä¢ Condicionamento f√≠sico\\n‚Ä¢ Qualidade de vida\\n\\nüéÅ *OFERTA ESPECIAL:*\\n7 dias GR√ÅTIS para voc√™ testar!\\n\\nüì± *ESCOLHA SUA OP√á√ÉO:*\\n1Ô∏è‚É£ Conhecer a academia\\n2Ô∏è‚É£ Valores e planos\\n3Ô∏è‚É£ Agendar avalia√ß√£o\\n4Ô∏è‚É£ Falar com consultor\\n\\nüí¨ *Digite o n√∫mero da op√ß√£o ou me conte seu objetivo!*\\n\\nüèÜ *Sua transforma√ß√£o come√ßa aqui!*`;\n\nreturn {\n  json: {\n    chatId: dados.chatId,\n    resposta: respostaPadrao,\n    prioridade: 'media',\n    followUpDelay: '24 hours'\n  }\n};"
      },
      "id": "response-standard",
      "name": "üí¨ RESPOSTA PADR√ÉO",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 380]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://localhost:3000/api/sendText",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={\n  \"chatId\": \"{{ $json.chatId }}\",\n  \"text\": \"{{ $json.resposta }}\",\n  \"session\": \"default\"\n}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "send-waha-response",
      "name": "üì§ Enviar WAHA",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"Processado com sucesso\",\n  \"prioridade\": \"{{ $json.prioridade }}\",\n  \"timestamp\": \"{{ $now.toISOString() }}\"\n}"
      },
      "id": "webhook-response",
      "name": "‚úÖ Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": "1YviQakfTbBNZWkFOLqxIi5EORfOPmKTJz_qr-inIvo8",
        "sheetName": "Respostas_Enviadas",
        "range": "A:F",
        "options": {
          "headerRow": 1
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Telefone": "={{ $('üîç Parse WAHA Message').item.json.contactPhone }}",
            "Nome": "={{ $('üîç Parse WAHA Message').item.json.contactName }}",
            "Prioridade": "={{ $json.prioridade }}",
            "Data_Hora": "={{ $now.format('DD/MM/YYYY HH:mm') }}",
            "Status": "Enviado",
            "Tipo": "Resposta Autom√°tica"
          }
        }
      },
      "id": "log-response",
      "name": "üìä Log Resposta",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [1340, 480]
    }
  ],
  "connections": {
    "üì± WAHA Webhook": {
      "main": [
        [
          {
            "node": "üîç Parse WAHA Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Parse WAHA Message": {
      "main": [
        [
          {
            "node": "‚úÖ Filtro Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Filtro Mensagens": {
      "main": [
        [],
        [
          {
            "node": "üíæ Salvar Conversa",
            "type": "main",
            "index": 0
          },
          {
            "node": "üéØ Router Prioridade",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üéØ Router Prioridade": {
      "main": [
        [
          {
            "node": "üö® RESPOSTA CR√çTICA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ö° RESPOSTA ALTA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üí¨ RESPOSTA PADR√ÉO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üö® RESPOSTA CR√çTICA": {
      "main": [
        [
          {
            "node": "üì§ Enviar WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ö° RESPOSTA ALTA": {
      "main": [
        [
          {
            "node": "üì§ Enviar WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üí¨ RESPOSTA PADR√ÉO": {
      "main": [
        [
          {
            "node": "üì§ Enviar WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Enviar WAHA": {
      "main": [
        [
          {
            "node": "‚úÖ Webhook Response",
            "type": "main",
            "index": 0
          },
          {
            "node": "üìä Log Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "tags": [
    {
      "name": "Academia"
    },
    {
      "name": "WAHA"
    },
    {
      "name": "Resposta"
    },
    {
      "name": "Convers√£o"
    }
  ]
}